"""
–ì–ª–∞–≤–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –¥–µ–Ω–µ–∂–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞
–í–µ—Ä—Å–∏—è: 2.0 (—É–ª—É—á—à–µ–Ω–Ω–∞—è —Å –º–æ–¥—É–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π)
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime
import warnings
warnings.filterwarnings('ignore')

# –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞
from data_processor import DataProcessor
from visualizer import TransferVisualizer
from ml_models import run_ml_analysis

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä—É—Å—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
plt.rcParams['font.family'] = 'DejaVu Sans'
plt.rcParams['axes.unicode_minus'] = False

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∏–ª—è
try:
    plt.style.use('seaborn-v0_8-darkgrid')
except:
    plt.style.use('seaborn-darkgrid')
sns.set_palette("husl")


def print_header(text, char="="):
    """–ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤"""
    print("\n" + char*60)
    print(text)
    print(char*60)


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"""
    
    print_header("–ê–ù–ê–õ–ò–ó –ú–ï–ñ–ë–ê–ù–ö–û–í–°–ö–ò–• –î–ï–ù–ï–ñ–ù–´–• –ü–ï–†–ï–í–û–î–û–í –ö–ê–ó–ê–•–°–¢–ê–ù–ê", "=")
    print(f"–î–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    # JSON –¥–∞–Ω–Ω—ã–µ
    json_data = [
        {"id": "4", "transaction": "2682.9119999999948", "name_ru": "–º–∞—Ä—Ç 2025 –≥–æ–¥–∞", "quantity": "109585.26789273391", "name_kz": "2025 –∂—ã–ª“ì—ã –Ω–∞—É—Ä—ã–∑"},
        {"id": "9", "transaction": "3429.1889999999953", "name_ru": "–∞–≤–≥—É—Å—Ç 2025 –≥–æ–¥–∞", "quantity": "142582.03394310983", "name_kz": "2025 –∂—ã–ª“ì—ã —Ç–∞–º—ã–∑"},
        {"id": "5", "transaction": "2959.851999999993", "name_ru": "–∞–ø—Ä–µ–ª—å 2025 –≥–æ–¥–∞", "quantity": "131946.649815193", "name_kz": "2025 –∂—ã–ª“ì—ã —Å”ô—É—ñ—Ä"},
        {"id": "1", "transaction": "3152.6309999999999", "name_ru": "–¥–µ–∫–∞–±—Ä—å 2024 –≥–æ–¥–∞", "quantity": "138713.921", "name_kz": "2024 –∂—ã–ª“ì—ã –∂–µ–ª—Ç–æ“õ—Å–∞–Ω"},
        {"id": "6", "transaction": "2894.1909999999953", "name_ru": "–º–∞–π 2025 –≥–æ–¥–∞", "quantity": "125944.30161497451", "name_kz": "2025 –∂—ã–ª“ì—ã –º–∞–º—ã—Ä"},
        {"id": "2", "transaction": "2507.8829999999944", "name_ru": "—è–Ω–≤–∞—Ä—å 2025 –≥–æ–¥–∞", "quantity": "123621.69333810107", "name_kz": "2025 –∂—ã–ª“ì—ã “õ–∞“£—Ç–∞—Ä"},
        {"id": "7", "transaction": "2769.8629999999953", "name_ru": "–∏—é–Ω—å 2025 –≥–æ–¥–∞", "quantity": "131782.93793491169", "name_kz": "2025 –∂—ã–ª“ì—ã –º–∞—É—Å—ã–º"},
        {"id": "3", "transaction": "3310.3929999999918", "name_ru": "—Ñ–µ–≤—Ä–∞–ª—å 2025 –≥–æ–¥–∞", "quantity": "116193.44031632182", "name_kz": "2025 –∂—ã–ª“ì—ã –∞“õ–ø–∞–Ω"},
        {"id": "8", "transaction": "2913.4099999999935", "name_ru": "–∏—é–ª—å 2025 –≥–æ–¥–∞", "quantity": "145247.20371986751", "name_kz": "2025 –∂—ã–ª“ì—ã —à—ñ–ª–¥–µ"},
        {"id": "10", "transaction": "2752.4249999999938", "name_ru": "—Å–µ–Ω—Ç—è–±—Ä—å 2025 –≥–æ–¥–∞", "quantity": "113574.14790379892", "name_kz": "2025 –∂—ã–ª“ì—ã “õ—ã—Ä–∫“Ø–π–µ–∫"}
    ]
    
    # ========================================
    # –®–ê–ì 1: –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–•
    # ========================================
    print_header("–®–ê–ì 1: –û–ë–†–ê–ë–û–¢–ö–ê –ò –û–ß–ò–°–¢–ö–ê –î–ê–ù–ù–´–•")
    
    processor = DataProcessor(json_data)
    df = processor.process()
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—á–∏—â–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    df.to_csv('bank_transfers_clean.csv', index=False, encoding='utf-8-sig')
    print("\n‚úì –û—á–∏—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ 'bank_transfers_clean.csv'")
    
    # ========================================
    # –®–ê–ì 2: –û–ü–ò–°–ê–¢–ï–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
    # ========================================
    print_header("–®–ê–ì 2: –û–ü–ò–°–ê–¢–ï–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê")
    
    processor.print_statistics()
    
    # ========================================
    # –®–ê–ì 3: –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø
    # ========================================
    print_header("–®–ê–ì 3: –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–•")
    
    visualizer = TransferVisualizer(df)
    visualizer.create_all_visualizations()
    
    # ========================================
    # –®–ê–ì 4: –ú–ê–®–ò–ù–ù–û–ï –û–ë–£–ß–ï–ù–ò–ï
    # ========================================
    print_header("–®–ê–ì 4: –ú–ê–®–ò–ù–ù–û–ï –û–ë–£–ß–ï–ù–ò–ï –ò –ü–†–û–ì–ù–û–ó–ò–†–û–í–ê–ù–ò–ï")
    
    if len(df) >= 5:
        analyzer, results = run_ml_analysis('bank_transfers_clean.csv')
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ML
        results.to_csv('ml_model_comparison.csv', index=False, encoding='utf-8-sig')
        print("\n‚úì –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ 'ml_model_comparison.csv'")
    else:
        print("\n‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ML-–∞–Ω–∞–ª–∏–∑–∞ (–Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 5 –∑–∞–ø–∏—Å–µ–π)")
    
    # ========================================
    # –®–ê–ì 5: –í–´–í–û–î–´
    # ========================================
    print_header("–®–ê–ì 5: –ö–õ–Æ–ß–ï–í–´–ï –í–´–í–û–î–´ –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò")
    
    generate_insights(df)
    
    # ========================================
    # –ó–ê–í–ï–†–®–ï–ù–ò–ï
    # ========================================
    print_header("–ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–Å–ù –£–°–ü–ï–®–ù–û!", "=")
    print("\n–°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:")
    print("  1. bank_transfers_clean.csv - –æ—á–∏—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
    print("  2. bank_transfers_analysis.png - –±–∞–∑–æ–≤–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è")
    print("  3. ml_comprehensive_analysis.png - ML –∞–Ω–∞–ª–∏–∑")
    print("  4. ml_model_comparison.csv - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π")
    
    plt.show()


def generate_insights(df):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö –≤—ã–≤–æ–¥–æ–≤ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π"""
    
    # –¢—Ä–µ–Ω–¥—ã
    amount_change = ((df['amount_billion_tenge'].iloc[-1] / df['amount_billion_tenge'].iloc[0]) - 1) * 100
    trans_change = ((df['transactions_thousand'].iloc[-1] / df['transactions_thousand'].iloc[0]) - 1) * 100
    
    print("\n1. –î–ò–ù–ê–ú–ò–ö–ê –ü–û–ö–ê–ó–ê–¢–ï–õ–ï–ô:")
    print(f"   ‚Ä¢ –û–±—ä—ë–º –ø–µ—Ä–µ–≤–æ–¥–æ–≤: {'‚Üë' if amount_change > 0 else '‚Üì'} {abs(amount_change):.1f}%")
    print(f"   ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {'‚Üë' if trans_change > 0 else '‚Üì'} {abs(trans_change):.1f}%")
    
    print("\n2. –≠–ö–°–¢–†–ï–ú–ê–õ–¨–ù–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø:")
    peak_idx = df['amount_billion_tenge'].idxmax()
    low_idx = df['amount_billion_tenge'].idxmin()
    print(f"   ‚Ä¢ –ü–∏–∫–æ–≤—ã–π –º–µ—Å—è—Ü: {df.loc[peak_idx, 'period']} ({df.loc[peak_idx, 'amount_billion_tenge']:.2f} –º–ª—Ä–¥)")
    print(f"   ‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –º–µ—Å—è—Ü: {df.loc[low_idx, 'period']} ({df.loc[low_idx, 'amount_billion_tenge']:.2f} –º–ª—Ä–¥)")
    
    print("\n3. –°–†–ï–î–ù–ò–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò:")
    print(f"   ‚Ä¢ –°—Ä–µ–¥–Ω–∏–π –æ–±—ä—ë–º –≤ –º–µ—Å—è—Ü: {df['amount_billion_tenge'].mean():.2f} –º–ª—Ä–¥ —Ç–µ–Ω–≥–µ")
    print(f"   ‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: {df['avg_transaction_size'].mean():.2f} —Ç–µ–Ω–≥–µ")
    
    print("\n4. –í–û–õ–ê–¢–ò–õ–¨–ù–û–°–¢–¨:")
    volatility = (df['amount_billion_tenge'].std() / df['amount_billion_tenge'].mean()) * 100
    print(f"   ‚Ä¢ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏: {volatility:.1f}%")
    print(f"   ‚Ä¢ –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è: {'–í—ã—Å–æ–∫–∞—è' if volatility > 15 else '–£–º–µ—Ä–µ–Ω–Ω–∞—è' if volatility > 10 else '–ù–∏–∑–∫–∞—è'} –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å")
    
    print("\n5. –ö–û–†–†–ï–õ–Ø–¶–ò–Ø:")
    corr = df['amount_billion_tenge'].corr(df['transactions_thousand'])
    print(f"   ‚Ä¢ –û–±—ä—ë–º vs –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {corr:.4f}")
    print(f"   ‚Ä¢ –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è: {'–°–∏–ª—å–Ω–∞—è' if abs(corr) > 0.7 else '–£–º–µ—Ä–µ–Ω–Ω–∞—è' if abs(corr) > 0.4 else '–°–ª–∞–±–∞—è'} —Å–≤—è–∑—å")
    
    print("\n6. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:")
    if amount_change < 0:
        print("   ‚ö† –û–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–Ω–∏–∂–µ–Ω–∏–µ –æ–±—ä—ë–º–æ–≤ –ø–µ—Ä–µ–≤–æ–¥–æ–≤")
    if volatility > 15:
        print("   ‚ö† –í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ —Ä–∏—Å–∫–∞")
    if corr < 0.5:
        print("   üí° –°–ª–∞–±–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π")
    
    # –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å
    monthly_avg = df.groupby('month_num')['amount_billion_tenge'].mean()
    best_month = monthly_avg.idxmax()
    worst_month = monthly_avg.idxmin()
    
    month_names = ['', '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                   '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å']
    
    print("\n7. –°–ï–ó–û–ù–ù–û–°–¢–¨:")
    print(f"   ‚Ä¢ –ù–∞–∏–±–æ–ª–µ–µ –∞–∫—Ç–∏–≤–Ω—ã–π –º–µ—Å—è—Ü: {month_names[best_month]}")
    print(f"   ‚Ä¢ –ù–∞–∏–º–µ–Ω–µ–µ –∞–∫—Ç–∏–≤–Ω—ã–π –º–µ—Å—è—Ü: {month_names[worst_month]}")
    
    # –¢—Ä–µ–Ω–¥ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –º–µ—Å—è—Ü–µ–≤
    recent_trend = df['amount_billion_tenge'].tail(3).mean()
    overall_avg = df['amount_billion_tenge'].mean()
    
    print("\n8. –ö–†–ê–¢–ö–û–°–†–û–ß–ù–´–ô –¢–†–ï–ù–î:")
    if recent_trend > overall_avg * 1.05:
        print("   üìà –ü–æ—Å–ª–µ–¥–Ω–∏–µ –º–µ—Å—è—Ü—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–æ—Å—Ç –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ")
    elif recent_trend < overall_avg * 0.95:
        print("   üìâ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –º–µ—Å—è—Ü—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ")
    else:
        print("   ‚û°Ô∏è –ü–æ—Å–ª–µ–¥–Ω–∏–µ –º–µ—Å—è—Ü—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å—Ä–µ–¥–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è")


if __name__ == "__main__":
    main()